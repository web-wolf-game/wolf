<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/5.5.6/firebase.js"></script>
<script src="script.js"></script>
<script>
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(g){var a=0;return function(){return a<g.length?{done:!1,value:g[a++]}:{done:!0}}};$jscomp.arrayIterator=function(g){return{next:$jscomp.arrayIteratorImpl(g)}};$jscomp.makeIterator=function(g){var a="undefined"!=typeof Symbol&&Symbol.iterator&&g[Symbol.iterator];return a?a.call(g):$jscomp.arrayIterator(g)};
function Main(){localStorage.kfs=localStorage.kfs||"{}";var g=JSON.parse(localStorage.kfs);System.member=g.wolf||{};System._sessionStorage=JSON.parse(sessionStorage.kfs||"{}");ServerTime();if(void 0===System.member.account)var a=setInterval(function(){void 0!==System.SerialNumber&&null!==System.SerialNumber&&(clearInterval(a),RegisterMemberChar(),MenuLi(),MenuClick("char_info","close"))},10);else DB.ref("/member/"+System.member.account).once("value",function(h){h=h.val();null===h?(delete localStorage.kfs,
location.reload()):h.password!==System.member.password?(delete localStorage.kfs,location.reload()):(DB.ref("/member/"+System.member.account).update({time_last:firebase.database.ServerValue.TIMESTAMP}),DB.ref("/char/"+System.member.account).update({time_last:firebase.database.ServerValue.TIMESTAMP}),DB.ref("/char/"+System.member.account).once("value",function(b){System["char"]=b.val();MenuLi();""===System["char"].name&&MenuClick("char_info","close");""!==System["char"].game_sn&&(System._sessionStorage.menuclick.data_id.game_list=
System["char"].game_sn,sessionStorage.kfs=JSON.stringify(System._sessionStorage),MenuClick("game_list","close"));void 0!==System._sessionStorage.menuclick&&MenuClick(System._sessionStorage.menuclick.menu,"close")}))})}
function MenuLi(){var g=document.createElement("div");g.id="Time";g.addEventListener("click",function(){delete System._sessionStorage.menuclick;sessionStorage.kfs=JSON.stringify(System._sessionStorage);document.querySelectorAll("#Menu ul>div").forEach(function(k,c){k.style.height="0px"})});var a=document.createElement("div");a.id="Menu";var h=document.createElement("ul"),b={account:{name:"\u5e33\u865f\u7ba1\u7406"},char_info:{name:"\u73a9\u5bb6\u8cc7\u8a0a"},char_list:{name:"\u73a9\u5bb6\u6e05\u55ae"},
game_create:{name:"\u5efa\u7acb\u904a\u6232"},game_list:{name:"\u904a\u6232\u5217\u8868"}};""===System["char"].name&&(b={account:{name:"\u5e33\u865f\u7ba1\u7406"},char_info:{name:"\u73a9\u5bb6\u8cc7\u8a0a"}});for(var m in b){var e=document.createElement("li");e.id=m;e.innerHTML=b[m].name;h.appendChild(e);e=document.createElement("div");e.id=m;h.appendChild(e)}a.appendChild(h);document.body.appendChild(g);document.body.appendChild(a);document.querySelectorAll("#Menu ul li").forEach(function(k){k.addEventListener("click",
function(){MenuClick(k.id,"close")})})}
function MenuClick(g,a){System._sessionStorage.menuclick=System._sessionStorage.menuclick||{};System._sessionStorage.menuclick.menu=g;System._sessionStorage.menuclick.data_id=System._sessionStorage.menuclick.data_id||{};System._sessionStorage.menuclick.data_id[g]=System._sessionStorage.menuclick.data_id[g]||"list";System._sessionStorage.menuclick.search=System._sessionStorage.menuclick.search||{};sessionStorage.kfs=JSON.stringify(System._sessionStorage);if("close"==a)document.querySelectorAll("#Menu ul>div").forEach(function(c,
d){c.style.height="0px"}),setTimeout(function(){MenuClick(g,"open")},0);else{var h=document.createElement("div");h.id="Main";var b={};"account"==g&&(b={account:{type:"text",span:"\u5e33\u865f\u5e8f\u865f",disabled:"disabled",value:System.member.account},password:{type:"text",span:"\u5e33\u865f\u7e7c\u627f\u78bc",disabled:"disabled",value:System.member.password||""},button:{type:"button",value:"\u66f4\u65b0\u7e7c\u627f\u78bc",span:"",event:{click:EditAccount}},button2:{type:"button",value:"\u7e7c\u627f\u5df2\u6709\u5e33\u865f",
span:"",event:{click:OldAccount}},button3:{type:"button",value:"\u6e05\u9664\u5e33\u865f\u8cc7\u6599",span:"",event:{click:DelAccount}}},RowMake(b,h,g));if("char_info"==g){var m=System.c_s_word;for(e in System.char_default)void 0!==m[e]&&(b[e]={type:"text",span:m[e],disabled:"disabled",value:JSON.parse(JSON.stringify(System["char"][e])),"class":"number"},"item"==e&&(b[e].value=System["char"].item.money));b.name["class"]="";""===System["char"].name&&delete b.name.disabled;""===System["char"].name&&
(b.button={type:"button",value:"\u6c7a\u5b9a\u89d2\u8272\u540d\u7a31",span:"",event:{click:EditChar}},m=document.createElement("div"),m.className="info",m.innerHTML="\u8acb\u8f38\u5165\u89d2\u8272\u540d\u7a31\u4e26\u5132\u5b58\u958b\u59cb\u904a\u6232<BR>\u89d2\u8272\u540d\u7a31\u65e5\u5f8c\u4e0d\u53ef\u66f4\u6539<BR>\u6216\u5728\u3010\u5e33\u865f\u7ba1\u7406\u3011\u4f7f\u7528\u5e8f\u865f\u53ca\u7e7c\u627f\u78bc\u7e7c\u627f\u5df2\u6709\u5e33\u865f",h.appendChild(m));RowMake(b,h,g)}if("char_list"==
g)if("list"!=System._sessionStorage.menuclick.data_id[g])m=document.createElement("div"),m.className="info btn",m.innerHTML="\u56de\u5230\u5217\u8868",m.addEventListener("click",function(){System._sessionStorage.menuclick.data_id[g]="list";sessionStorage.kfs=JSON.stringify(System._sessionStorage);MenuClick("char_list","open")}),h.appendChild(m),DB.ref("/char/"+System._sessionStorage.menuclick.data_id[g]).once("value",function(c){c=c.val();if(null===c)System._sessionStorage.menuclick.data_id[g]="list",
sessionStorage.kfs=JSON.stringify(System._sessionStorage),MenuClick("char_list","open");else{var d=System.c_s_word,n;for(n in System.char_default)void 0!==d[n]&&(b[n]={type:"text",span:d[n],disabled:"disabled",value:JSON.parse(JSON.stringify(c[n])),"class":"number"},"item"==n&&(b[n].value=c.item.money));b.name["class"]="";RowMake(b,h,g)}});else{var e=document.createElement("div");e.className="info";m=document.createElement("span");m.className="btn";m.innerHTML="\u641c\u5c0b";var k=document.createElement("input");
k.type="text";k.id="search_keyword";k.value=System._sessionStorage.menuclick.search.keyword||"";e.appendChild(k);e.appendChild(m);h.appendChild(e);m.addEventListener("click",function(){var c=document.querySelector("#search_keyword").value;System._sessionStorage.menuclick.search.keyword=c;sessionStorage.kfs=JSON.stringify(System._sessionStorage);MenuClick(g,"close")});DB.ref("/char/").once("value",function(c){c=c.val();var d=[],n;for(n in c){var f=c[n];if(""!==f.name&&(""==System._sessionStorage.menuclick.search.keyword||
void 0==System._sessionStorage.menuclick.search.keyword||-1!=f.name.toString().indexOf(System._sessionStorage.menuclick.search.keyword))){var l=d.length;d[l]=f;d[l].id=n;d[l].name_account="\u3010"+f.name+"\u3011";d[l].time_last_word=DateFormat(new Date(f.time_last))}}d=SortData(d,"time_last",1);ListMake({0:{title:"\u73a9\u5bb6\u540d\u7a31","class":"btn",id:"id",html:"name_account",event:{click:function(){System._sessionStorage.menuclick.data_id[g]=this.id;sessionStorage.kfs=JSON.stringify(System._sessionStorage);
MenuClick("char_list","open")}}},2:{title:"\u6700\u5f8c\u6d3b\u52d5\u6642\u9593",html:"time_last_word"}},d,h,g)});return}if("game_create"==g){for(e in System.create_game_row)b[e]={type:System.create_game_row[e].type,span:System.create_game_row[e].name,"class":System.create_game_row[e].type,value:System.create_game_row[e].value||""};DB.ref("/char/"+System.member.account).once("value",function(c){System["char"]=c.val();b.button=""===System["char"].game_sn?{type:"button",value:"\u5efa\u7acb\u904a\u6232",
span:"",event:{click:function(){GameFunc("create")}}}:{type:"button",value:"\u5df2\u52a0\u5165\u904a\u6232\uff0c\u4e0d\u53ef\u5efa\u7acb\u65b0\u904a\u6232\uff0c\u524d\u5f80\u5df2\u52a0\u5165\u904a\u6232",span:"",event:{click:function(){System._sessionStorage.menuclick.data_id[g]=System["char"].game_sn;sessionStorage.kfs=JSON.stringify(System._sessionStorage);MenuClick("game_list","close")}}};RowMake(b,h,g)})}"game_list"==g&&("list"!=System._sessionStorage.menuclick.data_id[g]?(m=document.createElement("div"),
m.className="info btn",m.innerHTML="\u56de\u5230\u5217\u8868",m.addEventListener("click",function(){System._sessionStorage.menuclick.data_id[g]="list";sessionStorage.kfs=JSON.stringify(System._sessionStorage);MenuClick(g,"open")}),h.appendChild(m),m=document.createElement("div"),m.className="info btn",m.innerHTML="\u524d\u5f80\u5c0d\u8a71\u5340",m.addEventListener("click",function(){location.href="chat.html"}),h.appendChild(m),m=document.createElement("div"),m.className="info",m.innerHTML="\u3010"+
System._sessionStorage.menuclick.data_id[g]+"\u3011",h.appendChild(m),DB.ref("/game/"+System._sessionStorage.menuclick.data_id[g]).once("value",function(c){c=c.val();DB.ref("/char/"+System.member.account).once("value",function(d){System["char"]=d.val();if(null===c)System._sessionStorage.menuclick.data_id[g]="list",sessionStorage.kfs=JSON.stringify(System._sessionStorage),System["char"].game_sn="",System["char"].game_day="",System["char"].game_time="",System["char"].game_end="",DB.ref("/char/"+System.member.account).update(System["char"]),
MenuClick(g,"close");else{sessionStorage.game=JSON.stringify(c);""!=System["char"].game_sn&&(System["char"].game_day=c.nowday,System["char"].game_time=c.nowtime,System["char"].game_end=c.end,DB.ref("/char/"+System.member.account).update(System["char"]));"start"===c.end&&GameStart(h,c,g);"end"===c.end&&GameEnd(h,c,g);d=c.char_list[System.member.account]||{};if("ready"==c.end){var n=document.createElement("div");n.className="info";n.innerHTML="";void 0!==d.nickname&&(n.innerHTML+="\u6b64\u5c40\u7684\u89d2\u8272\u540d\u7a31\u70ba\u3010"+
d.nickname+"\u3011<BR>");n.innerHTML+="\u76ee\u524d\u52a0\u5165\u73a9\u5bb6\u3010"+Object.keys(c.char_list).length+"\u3011\u540d\uff0c\u9084\u5dee\u3010"+(c.config.char_count-Object.keys(c.char_list).length)+"\u3011\u540d\u73a9\u5bb6<BR>\u6309\u4e0b\u3010\u6e96\u5099\u5b8c\u6210\u3011\u9215\u7b49\u5f85\u623f\u4e3b\u3010\u958b\u59cb\u904a\u6232\u3011";h.appendChild(n);""===System["char"].game_sn&&(b.button={type:"button",value:"\u52a0\u5165\u904a\u6232",span:"",event:{click:function(){GameFunc("join")}}});
c.char_create==System.member.account&&(b.start_button={type:"button",value:"\u958b\u59cb\u904a\u6232",span:"",event:{click:function(){GameFunc("start",c.sn)}}});System["char"].game_sn===c.sn&&(b.button2={type:"button",value:"\u9000\u51fa\u6b64\u904a\u6232",span:"",event:{click:function(){GameFunc("quit",System.member.account)}}},System.member.account!=c.char_create&&(n="\u6e96\u5099\u5b8c\u6210","yes"==d.ready&&(n="\u7b49\u5f85\u623f\u4e3b\u958b\u59cb\u904a\u6232"),b.button3={type:"button",value:n,
span:"",event:{click:function(){GameFunc("start",c.sn)}}}));System["char"].game_sn!=c.sn&&""!=System["char"].game_sn&&"ready"==c.end&&(b.button3={type:"button",value:"\u5df2\u52a0\u5165\u5176\u4ed6\u904a\u6232\uff0c\u524d\u5f80\u5df2\u52a0\u5165\u904a\u6232",span:"",event:{click:function(){System._sessionStorage.menuclick.data_id[g]=this.id;sessionStorage.kfs=JSON.stringify(System._sessionStorage);MenuClick("game_list","close")}}});RowMake(b,h,g);h.appendChild(document.createElement("p"))}if("ready"==
c.end){n=document.createElement("div");n.className="info";n.innerHTML="\u8cfc\u8cb7\u9053\u5177\uff0c\u76ee\u524d\u6301\u6709\u91d1\u9322\u3010"+System["char"].item.money+"\u3011";h.appendChild(n);item=c.item;n=[{title:"\u9053\u5177",html:"name"},{title:"\u50f9\u9322",html:"money"},{title:"\u8cfc\u8cb7",html:"buy",id:"id","class":"btn",event:{click:function(){for(var v in item)if(v==this.id&&System["char"].item.money<item[v].money){alert("\u91d1\u9322\u4e0d\u8db3");return}BuyItem(this.id)}}}];var f=
[];for(p in item){var l=f.length;f[l]=item[p];f[l].name=p;f[l].id=p;c.char_list[System.member.account]?f[l].buy=void 0!==c.char_list[System.member.account].item[p]?"\u5df2\u8cfc\u8cb7":"\u8cfc\u8cb7":delete n["2"]}ListMake(n,f,h,g);h.appendChild(document.createElement("p"))}n=[];n=[{title:"\u73a9\u5bb6\u5217\u8868",html:"nickname_word",id:"id","class":"btn vote",event:{click:function(){"vote"===System["char"].action&&!0===confirm("\u78ba\u5b9a\u8981\u6295\u7968\u7d66"+this.innerHTML+"\u55ce?")&&(clearInterval(System.focus_timer),
Vote(this.id));var v={wolf:"\u54ac\u6bba",divine:"\u5360\u535c",guard:"\u5b88\u885b"};"vote"!==System["char"].action&&void 0!==System["char"].action&&""!==System["char"].action&&!0===confirm("\u78ba\u5b9a\u8981"+v[c.char_list[System.member.account].job]+this.innerHTML+"\u55ce?")&&(clearInterval(System.focus_timer),Vote(this.id))}}},{title:"\u8e22\u9664\u73a9\u5bb6",html:"quit",id:"id","class":"btn",event:{click:function(){GameFunc("quit",this.id)}}},{title:"\u6e96\u5099\u72c0\u614b",html:"ready_status"}];
"end"===c.end&&(n["0"].event={click:function(){System._sessionStorage.menuclick.data_id[g]=this.id;sessionStorage.kfs=JSON.stringify(System._sessionStorage);MenuClick("char_list","close")}});c.char_create==System.member.account&&"ready"===c.end||n.splice(1,1);"ready"!==c.end&&n.splice(1,1);"start"==c.end&&(n[Object.keys(n).length]={title:"\u73a9\u5bb6\u72c0\u614b","class":"btn",id:"id",html:"action_end",event:{click:function(){if(0!=confirm("\u78ba\u5b9a\u8981\u5f37\u5236\u6b7b\u4ea1\u3010"+c.char_list[this.id].nickname+
"\u3011\u73a9\u5bb6\u55ce?\n(\u6ce8\u610f:\u5f37\u5236\u6b7b\u4ea1\u8a72\u73a9\u5bb6\u6703\u6709\u91d1\u9322\u61f2\u7f70)")){if("human"==c.nowtime){if((""!=c.char_list[this.id].vote[c.nowday].value||""!=c.char_list[this.id].pass[c.nowday].value)&&0==confirm("\u3010"+c.char_list[this.id].nickname+"\u3011\u73a9\u5bb6\u5df2\u884c\u52d5\uff0c\u78ba\u5b9a\u4ecd\u8981\u5f37\u5236\u6b7b\u4ea1\u55ce?\n(\u6ce8\u610f:\u5f37\u5236\u6b7b\u4ea1\u8a72\u73a9\u5bb6\u6703\u6709\u91d1\u9322\u61f2\u7f70)"))return}else if(""!=
c.char_list[this.id].pass[c.nowday].value&&0==confirm("\u3010"+c.char_list[this.id].nickname+"\u3011\u73a9\u5bb6\u5df2\u884c\u52d5\uff0c\u78ba\u5b9a\u4ecd\u8981\u5f37\u5236\u6b7b\u4ea1\u55ce?\n(\u6ce8\u610f:\u5f37\u5236\u6b7b\u4ea1\u8a72\u73a9\u5bb6\u6703\u6709\u91d1\u9322\u61f2\u7f70)"))return;var v={};v.dead={status:"dead",day:c.nowday,time:firebase.database.ServerValue.TIMESTAMP,type:"kick"};var w={};w.item={money:c.char_list[this.id].item.money-20*Object.keys(c.char_list).length};DB.ref("/game/"+
c.sn+"/char_list/"+this.id).update(v);DB.ref("/char/"+this.id).update(w);MenuClick("game_list","close")}}}});void 0===c.char_list[System.member.account]||"divine"!==c.char_list[System.member.account].job&&"psychic"!==c.char_list[System.member.account].job||(n[n.length]={title:{divine:"\u5360\u535c\u7d50\u679c",psychic:"\u9748\u5a92\u7d50\u679c"}[c.char_list[System.member.account].job],"class":"btn",html:"_divine_psychic"});"end"===c.end&&(n[n.length]={title:"\u8077\u696d","class":"btn",html:"job_word"});
f=[];var p={vote:"\u88ab\u6751\u6c11\u540a\u6b7b",wolf:"\u88ab\u72fc\u4eba\u54ac\u6b7b",kick:"\u5f37\u5236\u6b7b\u4ea1"};for(var q in c.char_list){l=f.length;f[l]=c.char_list[q];f[l].id=q;f[l].action_end="human"==c.nowtime?""!=c.char_list[q].vote[c.nowday].value||""!=c.char_list[q].pass[c.nowday].value?"\u5df2\u884c\u52d5":"<span class=red>\u672a\u884c\u52d5</span>":""!=c.char_list[q].pass[c.nowday].value?"\u5df2\u884c\u52d5":"<span class=red>\u672a\u884c\u52d5</span>";if("dead"===c.char_list[q].dead.status){var u=
"";u+="\u7b2c"+c.char_list[q].dead.day+"\u5929";u+=p[c.char_list[q].dead.type];f[l].nickname_word="<s>\u3010"+c.char_list[q].nickname+"\u3011(\u6b7b\u4ea1)</s><BR>"+u}else f[l].nickname_word="\u3010"+c.char_list[q].nickname+"\u3011";"end"===c.end&&(f[l].nickname_word+="<BR>\u73a9\u5bb6\u5e33\u865f\u3010"+c.char_list[q].name+"\u3011");f[l].quit="\u8e22\u9664\u73a9\u5bb6";q==c.char_create?(f[l].quit="\u623f\u4e3b",f[l].ready_status="\u623f\u4e3b"):f[l].ready_status="yes"==c.char_list[q].ready?"\u6e96\u5099\u5b8c\u6210":
"<span class=red>\u5c1a\u672a\u6e96\u5099</span>";f[l]._divine_psychic="\u7121";if(void 0!==d&&"divine"===d.job)for(var t in d.divine)d.divine[t].value!==q||""==d.divine[t].value||void 0===d.divine[t].value||c.nowday<=t&&"wolf"==c.nowtime||!("dead"!=d.dead.status||t<d.dead.day)||(f[l]._divine_psychic="wolf"===c.char_list[d.divine[t].value].job?"\u7b2c"+t+"\u5929\u5360\u535c\u7d50\u679c<BR>\u3010\u72fc\u4eba\u3011":"\u7b2c"+t+"\u5929\u5360\u535c\u7d50\u679c<BR>\u3010\u4eba\u985e\u3011");if(void 0!==
d&&"psychic"===d.job)for(t in d.psychic)d.psychic[t].value===q&&""!=d.psychic[t].value&&void 0!==d.psychic[t].value&&("dead"!=d.dead.status||t<d.dead.day)&&(f[l]._divine_psychic="wolf"===c.char_list[d.psychic[t].value].job?"\u7b2c"+t+"\u5929\u9748\u5a92\u7d50\u679c<BR>\u3010\u72fc\u4eba\u3011":"\u7b2c"+t+"\u5929\u9748\u5a92\u7d50\u679c<BR>\u3010\u4eba\u985e\u3011");q.toString()!==System.member.account&&"dead"!==c.char_list[q].dead.status||"end"==c.end||(f[l]["class"]="btn",f[l].event="remove");"end"===
c.end&&(f[l].job_word=System.job_word[c.char_list[q].job])}ListMake(n,f,h,g);h.appendChild(document.createElement("p"));b=[];for(var r in System.create_game_row)b[r]={type:System.create_game_row[r].type,span:System.create_game_row[r].name,disabled:"disabled","class":System.create_game_row[r].type,value:c.config[r]||c[r]},"game_nickname"==r&&(b[r].value="",delete b[r].disabled),"game_password"==r&&c.char_create!=System.member.account&&c.sn!=System["char"].game_sn&&(b[r].value="",delete b[r].disabled);
if(System["char"].game_sn==c.sn||"end"==c.end)delete b.game_nickname,delete b.game_password;""===c.game_password&&(b.game_password={type:"hidden",span:""});RowMake(b,h,g);h.appendChild(document.createElement("p"))}})})):(e=document.createElement("div"),e.className="info",m=document.createElement("span"),m.className="btn",m.innerHTML="\u641c\u5c0b",k=document.createElement("input"),k.type="text",k.id="search_keyword",k.value=System._sessionStorage.menuclick.search.keyword||"",e.appendChild(k),e.appendChild(m),
h.appendChild(e),m.addEventListener("click",function(){var c=document.querySelector("#search_keyword").value;System._sessionStorage.menuclick.search.keyword=c;sessionStorage.kfs=JSON.stringify(System._sessionStorage);MenuClick(g,"close")}),DB.ref("/game/").once("value",function(c){c=c.val();var d=[],n={ready:"\u7b49\u5f85\u73a9\u5bb6\u4e2d",start:"\u9032\u884c\u4e2d",end:"\u5df2\u7d50\u675f"},f=0,l=0,p;for(p in c)if("human"==c[p].win&&f++,"wolf"==c[p].win&&l++,""==System._sessionStorage.menuclick.search.keyword||
void 0==System._sessionStorage.menuclick.search.keyword||-1!=c[p].name.toString().indexOf(System._sessionStorage.menuclick.search.keyword)){var q=d.length;d[q]=c[p];d[q].name="\u3010"+c[p].name+"\u3011<BR>\u3010"+c[p].sn+"\u3011<BR>\u3010<span class=red>"+n[c[p].end]+"</span>\u3011";d[q].time_create=DateFormat(new Date(c[p].time_last),"<BR>")}d=SortData(d,"time_last",1);c=document.createElement("div");c.className="info";c.innerHTML="\u4eba\u985e\u7e3d\u52dd\u5834:"+f+"<BR>\u72fc\u4eba\u7e3d\u52dd\u5834:"+
l;h.appendChild(c);ListMake({0:{title:"\u904a\u6232\u540d\u7a31",html:"name","class":"btn",id:"sn",event:{click:function(){System._sessionStorage.menuclick.data_id[g]=this.id;sessionStorage.kfs=JSON.stringify(System._sessionStorage);MenuClick(g,"open")}}},1:{title:"\u958b\u59cb\u6642\u9593",html:"time_create"}},d,h,g)})))}}
function GameFunc(g,a){a=void 0===a?"":a;if("start"==g)DB.ref("/game/"+a).once("value",function(e){e=e.val();if(null===e)System._sessionStorage.menuclick.data_id.game_list="list",sessionStorage.kfs=JSON.stringify(System._sessionStorage),MenuClick("game_list","open");else if(System.member.account!=e.char_create)e.char_list[System.member.account].ready="yes"!=e.char_list[System.member.account].ready?"yes":"no",DB.ref("/game/"+a).set(e),MenuClick("game_list","close");else{e.char_list[System.member.account].ready=
"yes";var k=[],c=!0,d={},n=[],f;for(f in e.char_list){var l=k.length;k[l]=e.char_list[f];k[l].id=f;"yes"!=e.char_list[f].ready&&(c=!1);var p=e.char_list[f].item;for(r in p)"money"!=r&&(p[r].money>p.money||0==e.config[p[r].job+"_count"]?delete k[l].item[r]:(d[r]=d[r]||[],d[r].push(f)))}if(parseInt(e.config.char_count)!==Object.keys(e.char_list).length)alert("\u73a9\u5bb6\u4eba\u6578\u4e0d\u8db3"),MenuClick("game_list","close");else if(1!=c)alert("\u5c1a\u6709\u73a9\u5bb6\u6c92\u6309\u4e0b\u6e96\u5099\u5b8c\u6210"),
MenuClick("game_list","close");else if(0!=confirm("\u78ba\u5b9a\u8981\u958b\u59cb\u904a\u6232\u55ce?")){for(r in d){c=e.item[r].job;var q=0;p=[];if(1==d[r].length)p=d[r];else{var u=$jscomp.makeIterator(d[r]);for(f=u.next();!f.done;f=u.next())f=f.value,q<=e.char_list[f].human_lose- -1*e.char_list[f].wolf_lose&&(q=e.char_list[f].human_lose- -1*e.char_list[f].wolf_lose);u=$jscomp.makeIterator(d[r]);for(f=u.next();!f.done;f=u.next())f=f.value,q==e.char_list[f].human_lose- -1*e.char_list[f].wolf_lose&&
p.push(f);Shuffle(p)}console.log(JSON.parse(JSON.stringify(p)));for(q=0;q<e.config[c+"_count"]&&0!=p.length;q++){e.config[c+"_count"]--;f=p.pop();e.char_list[f].job=c;e.char_list[f].item.money-=e.item[r].money;DB.ref("/char/"+f).update({item:{money:e.char_list[f].item.money}});u=0;for(var t in k)k[t].id==f&&k.splice(u,1),u++}}for(l in e.config)if("char_count"!=l&&-1==n.indexOf(l.split("_")[0]))for(d=0;d<e.config[l];d++){Shuffle(k);var r=k.pop();r.job=l.split("_")[0];e.char_list[r.id]=r}n=k.length;
if(0!=n)for(d=0;d<n;d++)r=k.pop(),r.job="human",e.char_list[r.id]=r;delete e.config;console.log(e.char_list);console.log(e);e.end="start";e.nowtime="human";DB.ref("/game/"+a).update(e);alert("\u904a\u6232\u958b\u59cb");MenuClick("game_list","close")}}});if("create"==g){var h={config:{}},b=0;for(m in System.create_game_row){h.config[m]=document.querySelectorAll("textarea,input[type=text],[type=number]")[b].value;if("game_password"!=m&&(""===h.config[m]||void 0===h.config[m])){alert("\u5fc5\u586b\u6b04\u4f4d\u4e0d\u53ef\u7a7a\u767d");
MenuClick("create","open");return}b++}h.sn=System.SerialNumber;h.end="ready";h.name=h.config.name;h.game_memo=h.config.game_memo;h.game_password=h.config.game_password;var m=h.config.game_nickname;delete h.config.name;delete h.config.game_memo;delete h.config.game_password;delete h.config.game_nickname;if(parseInt(h.config.char_count)<parseInt(parseInt(h.config.wolf_count)+parseInt(h.config.divine_count)+parseInt(h.config.guard_count)+parseInt(h.config.psychic_count))){alert("\u4eba\u6578\u8a2d\u5b9a\u932f\u8aa4");
return}console.log(h.config);for(b in h.config)if(!0===Number.isNaN(parseInt(h.config[b]))){alert("\u4eba\u6578\u8a2d\u5b9a\u932f\u8aa4");return}h.config.human_count=h.config.char_count-parseInt(parseInt(h.config.wolf_count)+parseInt(h.config.divine_count)+parseInt(h.config.guard_count)+parseInt(h.config.psychic_count));h.char_list={};h.char_list[System.member.account]=System["char"];h.char_list[System.member.account].nickname=m;h.char_create=System.member.account;h.char_last=System.member.account;
h.time_create=firebase.database.ServerValue.TIMESTAMP;h.time_last=firebase.database.ServerValue.TIMESTAMP;h.nowday="0";h.nowtime="";h.win="";System["char"].game_sn=h.sn;DB.ref("/item/").once("value",function(e){e=e.val();h.item=e;DB.ref("/char/"+System.member.account).update(System["char"]);DB.ref("/game/"+h.sn).set(h);alert("\u904a\u6232\u5efa\u7acb\u5b8c\u6210");MenuClick("game_list","close")})}if("quit"==g)DB.ref("/game/"+System._sessionStorage.menuclick.data_id.game_list).once("value",function(e){e=
e.val();null===e?(System._sessionStorage.menuclick.data_id.game_list="list",sessionStorage.kfs=JSON.stringify(System._sessionStorage),MenuClick("game_list","open")):System["char"].game_day.toString()!==e.nowday.toString()||System["char"].game_time.toString()!==e.nowtime.toString()||System["char"].game_end.toString()!==e.end.toString()?location.reload():e.char_create!==System.member.account&&a!==System.member.account?MenuClick("game_list","close"):a===System.member.account&&e.char_create===System.member.account?
!0===confirm("\u904a\u6232\u5efa\u7acb\u8005\u96e2\u958b\u6703\u89e3\u6563\u5168\u90e8\u73a9\u5bb6\n\u78ba\u5b9a\u8981\u7e7c\u7e8c\u55ce?")&&(DB.ref("/game/"+e.sn).remove(),System["char"].game_sn="",DB.ref("/char/"+a).update({game_sn:""}),MenuClick("game_list","open")):(delete e.char_list[a],DB.ref("/char/"+a).update({game_sn:""}),DB.ref("/game/"+e.sn).update(e),alert("\u9000\u51fa\u904a\u6232\u6210\u529f"),MenuClick("game_list","close"))});if("join"==g)DB.ref("/game/"+System._sessionStorage.menuclick.data_id.game_list).once("value",
function(e){e=e.val();if(null===e)System._sessionStorage.menuclick.data_id.game_list="list",sessionStorage.kfs=JSON.stringify(System._sessionStorage),MenuClick("game_list","open");else if(parseInt(e.config.char_count)===Object.keys(e.char_list).length)alert("\u6b64\u5c40\u4eba\u6578\u5df2\u6eff");else{var k=document.querySelector("input#game_password").value,c=document.querySelector("input#game_nickname").value;if(""===c)alert("\u6b64\u5c40\u89d2\u8272\u540d\u7a31\u4e0d\u53ef\u7a7a\u767d"),document.querySelector("#game_nickname").focus();
else if(k!=e.game_password)alert("\u5bc6\u78bc\u932f\u8aa4,\u7121\u6cd5\u9032\u5165\u6b64\u904a\u6232"),document.querySelector("#game_password").focus();else{for(var d in e.char_list){if(c===e.char_list[d].nickname){alert("\u6b64\u5c40\u540d\u7a31\u5df2\u88ab\u4f7f\u7528");document.querySelector("#game_nickname").focus();return}if(d===System.member.account){alert("\u6b64\u5e33\u865f\u5df2\u52a0\u5165\u6b64\u904a\u6232");return}}e.char_list[System.member.account]=System["char"];e.char_list[System.member.account].nickname=
c;e.char_last=System.member.account;e.time_last=firebase.database.ServerValue.TIMESTAMP;System["char"].game_sn=e.sn;DB.ref("/char/"+System.member.account).update(System["char"]);DB.ref("/game/"+e.sn).update(e);alert("\u52a0\u5165\u904a\u6232\u6210\u529f");MenuClick("game_list","close")}}})}
function GameStart(g,a,h){var b=0,m=0,e="",k="",c=e="",d="";c=[];var n={wolf:"\u54ac\u6bba",divine:"\u5360\u535c",guard:"\u5b88\u885b"},f=a.char_list[System.member.account];for(l in a.char_list)a.char_list[l].vote[a.nowday]=a.char_list[l].vote[a.nowday]||{},a.char_list[l].pass[a.nowday]=a.char_list[l].pass[a.nowday]||{},l===System.member.account&&(k=a.char_list[l].vote[a.nowday].value||""),""!==a.char_list[l].vote[a.nowday].value&&void 0!==a.char_list[l].vote[a.nowday].value&&b++,""!==a.char_list[l].pass[a.nowday].value&&
void 0!==a.char_list[l].pass[a.nowday].value&&m++,"wolf"===a.char_list[l].job&&c.push("\u3010"+a.char_list[l].nickname+"\u3011");var l=document.createElement("div");l.className="info";void 0!==f?(l.innerHTML="\u6b64\u5c40\u7684\u540d\u7a31\u70ba\u3010"+f.nickname+"\u3011<BR>\u6b64\u5c40\u7684\u8077\u696d\u70ba\u3010"+System.job_word[f.job]+"\u3011<BR>","dead"==f.dead.status&&(l.innerHTML+="\u4f60\u5df2\u7d93\u6b7b\u4ea1<BR>"),"wolf"===f.job&&(l.innerHTML+="\u5168\u90e8\u4eba\u72fc\uff1a"+c.join("")+
"<BR>")):l.innerHTML="\u89c0\u6230\u6a21\u5f0f<BR>";void 0!==f&&"0"!==a.nowday&&("human"===a.nowtime?(f.vote[a.nowday]=f.vote[a.nowday]||{},k=f.vote[a.nowday].value,void 0!==k&&""!==k&&"pass"!=k&&(e=a.char_list[k].nickname),"pass"==k&&(e="pass"),l.innerHTML+="\u5df2\u6295\u7968\u4eba\u6578\uff1a\u3010"+b+"\u3011<BR>","dead"!=a.char_list[System.member.account].dead.status&&(l.innerHTML=""!==e&&"pass"!=e?l.innerHTML+("\u7b2c"+a.nowday+"\u5929\u7684\u6295\u7968\u5c0d\u8c61\u70ba\u3010"+e+"\u3011"):"pass"==
e?l.innerHTML+("\u7b2c"+a.nowday+"\u6295\u7968\u5929PASS"):l.innerHTML+("\u7b2c"+a.nowday+"\u5929\u5c1a\u672a\u6295\u7968"))):"wolf"===a.nowtime&&(l.innerHTML+="\u5df2\u884c\u52d5\u7d50\u675f\u4eba\u6578\uff1a\u3010"+m+"\u3011<BR>","dead"!=a.char_list[System.member.account].dead.status&&(f.pass[a.nowday]=f.pass[a.nowday]||{},e=f.pass[a.nowday].value,l.innerHTML=void 0===e||""===e?l.innerHTML+"\u4f60\u5c1a\u672a\u884c\u52d5\u7d50\u675f<BR>":l.innerHTML+"\u4f60\u5df2\u7d93\u884c\u52d5\u7d50\u675f<BR>",
"human"!==a.char_list[System.member.account].job&&"psychic"!==a.char_list[System.member.account].job&&(a.char_list[System.member.account][a.char_list[System.member.account].job][a.nowday]=a.char_list[System.member.account][a.char_list[System.member.account].job][a.nowday]||{},c=a.char_list[System.member.account][a.char_list[System.member.account].job][a.nowday].value,void 0!==c&&""!==c&&(d=a.char_list[c].nickname),l.innerHTML=""!==d?l.innerHTML+("\u7b2c"+a.nowday+"\u5929"+n[a.char_list[System.member.account].job]+
"\u7684\u76ee\u6a19\u70ba\u3010"+d+"\u3011"):l.innerHTML+("\u7b2c"+a.nowday+"\u5929"+n[a.char_list[System.member.account].job]+"\u7684\u76ee\u6a19\u5c1a\u672a\u9078\u64c7")))));g.appendChild(l);if(void 0!==f)if("0"===a.nowday){m=[{title:"\u5148\u8fce\u4f86\u591c\u665a",html:"",id:"id",title_class:"btn",title_event:{click:function(){System["char"].action="vote";Vote("wolf")}}},{title:"\u5148\u8fce\u4f86\u767d\u5929",html:"",id:"id",title_class:"btn",title_event:{click:function(){System["char"].action=
"vote";Vote("human")}}},{title:"PASS",html:"",id:"id",title_class:"btn",title_event:{click:function(){System["char"].action="vote";Vote("pass")}}}];var p={wolf:"\u5148\u8fce\u4f86\u591c\u665a",human:"\u5148\u8fce\u4f86\u767d\u5929",pass:"PASS"};l=document.createElement("div");l.className="info";l.innerHTML="\u7b2c\u4e00\u5929\u958b\u59cb\u524d\u8acb\u5148\u9078\u64c7\u5148\u8fce\u4f86\u591c\u665a\u6216\u65e9\u6668<BR>\u5148\u8fce\u4f86\u591c\u665a\u7531\u72fc\u4eba\u5148\u54ac\u4eba\uff0c\u5148\u8fce\u4f86\u767d\u5929\u7531\u4eba\u985e\u5148\u540a\u4eba<BR>\u5df2\u9078\u64c7\u4eba\u6578\uff1a\u3010"+
b+"\u3011<BR>";l.innerHTML=""!==k?l.innerHTML+("\u73fe\u5728\u9078\u64c7\uff1a\u3010"+p[k]+"\u3011"):l.innerHTML+"\u5c1a\u672a\u9078\u64c7";g.appendChild(l);b=[];ListMake(m,b,g,h)}else{l=document.createElement("div");l.className="info";l.innerHTML="\u3010\u7b2c"+a.nowday+"\u5929"+{wolf:"\u591c\u665a",human:"\u767d\u5929"}[a.nowtime]+"\u3011";g.appendChild(l);g.appendChild(document.createElement("p"));"dead"!=a.char_list[System.member.account].dead.status&&("human"===a.nowtime?(m=[{title:"\u6295\u7968",
html:"",id:"id",title_class:"btn",title_event:{click:function(){System["char"].action="vote";alert("\u9ede\u64ca\u73a9\u5bb6\u5217\u8868\u6c7a\u5b9a\u8981\u6295\u7968\u7684\u5c0d\u8c61");Focus(".vote")}}},{title:"PASS",html:"",id:"id",title_class:"btn",title_event:{click:function(){System["char"].action="vote";Vote("pass")}}}],b=[],ListMake(m,b,g,h),g.appendChild(document.createElement("p"))):"wolf"===a.nowtime&&(m=[],m["0"]={title:"\u884c\u52d5\u7d50\u675f",html:"",id:"id",title_class:"btn",title_event:{click:function(){System["char"].action=
"pass";Vote("pass")}}},void 0!==n[a.char_list[System.member.account].job]&&(m["1"]={title:n[a.char_list[System.member.account].job],html:"",id:"id",title_class:"btn",title_event:{click:function(){System["char"].action=a.char_list[System.member.account].job;alert("\u9ede\u64ca\u73a9\u5bb6\u5217\u8868\u6c7a\u5b9a\u8981"+n[a.char_list[System.member.account].job]+"\u7684\u5c0d\u8c61");Focus(".vote")}}}),b=[],ListMake(m,b,g,h),g.appendChild(document.createElement("p"))));m=[];b=[];m=[{title:"\u5929\u6578",
html:"day"},{title:"\u6d3b\u52d5\u8a18\u9304",html:"log"}];k={wolf:"\u5148\u8fce\u4f86\u591c\u665a",human:"\u5148\u8fce\u4f86\u767d\u5929",pass:"PASS"};l=[];for(d=0;d<=a.nowday;d++)if("human"!=a.nowtime||d!=a.nowday)for(p in f=b.length,b[f]={},b[f].day=d,b[f].log="",l[d]=[],e={vote:"\u88ab\u6751\u6c11\u540a\u6b7b",wolf:"\u88ab\u72fc\u4eba\u54ac\u6b7b",kick:"\u5f37\u5236\u6b7b\u4ea1"},a.char_list){c="";a.char_list[p].vote[d]=a.char_list[p].vote[d]||{};void 0===a.char_list[p].vote[d].value||""==a.char_list[p].vote[d].value||
"pass"==a.char_list[p].vote[d].value?(c="\u672a\u6295\u7968","pass"==a.char_list[p].vote[d].value&&(c="\u4e3b\u52d5\u68c4\u7968")):c=0==d?"\u6295\u7d66\u3010"+k[a.char_list[p].vote[d].value]+"\u3011":"\u6295\u7d66\u3010"+a.char_list[a.char_list[p].vote[d].value].nickname+"\u3011";b[f].log+="\u3010"+a.char_list[p].nickname+"\u3011"+c+"<BR>";l[d][l[d].length]={log_account:p,log_word:"\u3010"+a.char_list[p].nickname+"\u3011"+c+"<BR>",log_time:a.char_list[p].vote[d].time||0};"dead"==a.char_list[p].dead.status&&
0!==d&&a.char_list[p].dead.day==d&&(dead_type=e[a.char_list[p].dead.type],l[d][l[d].length]={log_account:p,log_word:"\u3010"+a.char_list[p].nickname+"\u3011"+dead_type+"<BR>",log_time:a.char_list[p].dead.time- -1E3||0});l[d]=SortData(l[d],"log_time",0);b[f].log="";for(var q in l[d])void 0!==a.char_list[l[d][q].log_account].dead.day&&d>a.char_list[l[d][q].log_account].dead.day||(c=" ",0!==l[d][q].log_time&&(c=DateFormat(new Date(l[d][q].log_time),!1)),b[f].log+=c.split(" ")[1]+l[d][q].log_word)}ListMake(m,
b,g,h);g.appendChild(document.createElement("p"))}}
function GameEnd(g,a,h){System["char"].game_sn===a.sn&&(System["char"].game_sn="",System["char"].game_day="",System["char"].game_time="",System["char"].game_end="",System["char"].game_log=System["char"].game_log||{},System["char"].game_log[Object.keys(System["char"].game_log).length]=a.sn,DB.ref("/char/"+System.member.account).update(System["char"]));var b,m=b=0;var e=0;for(var k in a.char_list)"dead"!==a.char_list[k].dead.status&&(b++,"wolf"===a.char_list[k].job&&m++,"wolf"!==a.char_list[k].job&&
e++);e="\u4eba\u985e";0!==m&&(e="\u72fc\u4eba");b="\u904a\u6232\u7d50\u675f\uff0c\u3010"+e+"\u3011\u7684\u52dd\u5229<BR>\u904a\u6232\u9032\u884c\u5929\u6578\uff1a\u3010"+a.nowday+"\u3011<BR>\u5b58\u6d3b\u4eba\u6578\uff1a\u3010"+b+"\u3011";m=document.createElement("div");m.className="info";m.innerHTML=b;g.appendChild(m);g.appendChild(document.createElement("p"));b=[];m={wolf:"\u5148\u8fce\u4f86\u591c\u665a",human:"\u5148\u8fce\u4f86\u767d\u5929",pass:"PASS"};e=[];for(k=0;k<=a.nowday;k++){var c=b.length;
b[c]={};b[c].day=k;b[c].log="";e[k]=[];for(var d in a.char_list){a.char_list[d].vote[k]=a.char_list[d].vote[k]||{};if(void 0===a.char_list[d].vote[k].value||""==a.char_list[d].vote[k].value||"pass"==a.char_list[d].vote[k].value){var n="\u672a\u6295\u7968";"pass"==a.char_list[d].vote[k].value&&(n="\u4e3b\u52d5\u68c4\u7968")}else n=0==k?"\u6295\u7d66\u3010"+m[a.char_list[d].vote[k].value]+"\u3011":"\u6295\u7d66\u3010"+a.char_list[a.char_list[d].vote[k].value].nickname+"\u3011";b[c].log+="\u3010"+a.char_list[d].nickname+
"\u3011"+n+"<BR>";e[k][e[k].length]={log_account:d,log_word:"\u3010"+a.char_list[d].nickname+"\u3011"+n+"<BR>",log_time:a.char_list[d].vote[k].time||0};"wolf"==a.char_list[d].job&&void 0!==a.char_list[d].wolf&&0!==k&&(a.char_list[d].wolf[k]=a.char_list[d].wolf[k]||{},n=void 0===a.char_list[d].wolf[k].value||""==a.char_list[d].wolf[k].value?"\u672a\u54ac\u6bba":"\u54ac\u6bba\u3010"+a.char_list[a.char_list[d].wolf[k].value].nickname+"\u3011",b[c].log+="\u3010"+a.char_list[d].nickname+"\u3011"+n+"<BR>",
e[k][e[k].length]={log_account:d,log_word:"\u3010"+a.char_list[d].nickname+"\u3011"+n+"<BR>",log_time:a.char_list[d].wolf[k].time||0});"divine"==a.char_list[d].job&&void 0!==a.char_list[d].divine&&0!==k&&(a.char_list[d].divine[k]=a.char_list[d].divine[k]||{},n=void 0===a.char_list[d].divine[k].value||""==a.char_list[d].divine[k].value?"\u672a\u5360\u535c":"\u5360\u535c\u3010"+a.char_list[a.char_list[d].divine[k].value].nickname+"\u3011",b[c].log+="\u3010"+a.char_list[d].nickname+"\u3011"+n+"<BR>",
e[k][e[k].length]={log_account:d,log_word:"\u3010"+a.char_list[d].nickname+"\u3011"+n+"<BR>",log_time:a.char_list[d].divine[k].time||0});"guard"==a.char_list[d].job&&void 0!==a.char_list[d].guard&&0!==k&&(a.char_list[d].guard[k]=a.char_list[d].guard[k]||{},n=void 0===a.char_list[d].guard[k].value||""==a.char_list[d].guard[k].value?"\u672a\u8b77\u885b":"\u8b77\u885b\u3010"+a.char_list[a.char_list[d].guard[k].value].nickname+"\u3011",b[c].log+="\u3010"+a.char_list[d].nickname+"\u3011"+n+"<BR>",e[k][e[k].length]=
{log_account:d,log_word:"\u3010"+a.char_list[d].nickname+"\u3011"+n+"<BR>",log_time:a.char_list[d].guard[k].time||0});"dead"==a.char_list[d].dead.status&&0!==k&&a.char_list[d].dead.day==k&&(n="\u88ab\u6751\u6c11\u540a\u6b7b","wolf"==a.char_list[d].dead.type&&(n="\u88ab\u72fc\u4eba\u54ac\u6b7b"),e[k][e[k].length]={log_account:d,log_word:"\u3010"+a.char_list[d].nickname+"\u3011"+n+"<BR>",log_time:a.char_list[d].dead.time- -1E3||0});e[k]=SortData(e[k],"log_time",0);b[c].log="";for(var f in e[k])void 0!==
a.char_list[e[k][f].log_account].dead.day&&k>a.char_list[e[k][f].log_account].dead.day||(n=" ",0!==e[k][f].log_time&&(n=DateFormat(new Date(e[k][f].log_time),!1)),b[c].log+=n.split(" ")[1]+e[k][f].log_word)}}console.log(e);ListMake([{title:"\u5929\u6578",html:"day"},{title:"\u6d3b\u52d5\u8a18\u9304",html:"log"}],b,g,h);g.appendChild(document.createElement("p"))}
function Vote(g){var a,h={wolf:"",guard:"",divine:"",psychic:""};DB.ref("/game/"+System["char"].game_sn).once("value",function(b){b=b.val();a=b.nowday;if(System["char"].game_day.toString()!==b.nowday.toString()||System["char"].game_time.toString()!==b.nowtime.toString()||System["char"].game_end.toString()!==b.end.toString())MenuClick("game_list","close");else if("dead"==b.char_list[System.member.account].dead.status)alert("\u89d2\u8272\u5df2\u6b7b\u4ea1");else{if("vote"===System["char"].action||"pass"===
System["char"].action){b.char_list[System.member.account][System["char"].action][a]=b.char_list[System.member.account][System["char"].action][a]||{};b.char_list[System.member.account][System["char"].action][a].value=g;var m=0,e=0,k={},c={};for(f in b.char_list)"dead"!==b.char_list[f].dead.status&&m++,void 0!==b.char_list[f][System["char"].action][a].value&&""!==b.char_list[f][System["char"].action][a].value&&(e++,k[f]=b.char_list[f][System["char"].action][a].value);if(Object.keys(k).length===m){for(var d in k)c[k[d]]=
c[k[d]]+1||1;m=[];e=[];for(d in c)"pass"!=d&&e.push(c[d]);e=Math.max.apply(null,e);for(d in c)e===c[d]&&m.push(d);if("0"===b.nowday.toString()){0==m.length&&(m=["human","wolf"]);1<m.length&&Shuffle(m);d=m.pop();b.nowday=(b.nowday- -1).toString();b.nowtime=d;for(var n in b.char_list){var f=b.char_list[n];f.vote[b.nowday]={value:"",time:""};f.pass[b.nowday]={value:"",time:""};f.wolf[b.nowday]={value:"",time:""};f.divine[b.nowday]={value:"",time:""};f.psychic[b.nowday]={value:"",time:""};f.guard[b.nowday]=
{value:"",time:""};f.human[b.nowday]={value:"",time:""}}}else{if("human"==b.nowtime)for(d in m)"pass"!=m[d]&&(b.char_list[m[d]].dead={status:"dead",day:b.nowday,time:firebase.database.ServerValue.TIMESTAMP,type:"vote"});else{c="";for(f in b.char_list)void 0!==b.char_list[f][b.char_list[f].job][a]&&(""!=h[b.char_list[f].job]?""!=b.char_list[f][b.char_list[f].job][a].value&&(d=[h[b.char_list[f].job],b.char_list[f][b.char_list[f].job][a].value],Shuffle(d),console.log(d),h[b.char_list[f].job]=d.pop()):
h[b.char_list[f].job]=b.char_list[f][b.char_list[f].job][a].value),"psychic"===b.char_list[f].job&&(c=f),"dead"===b.char_list[f].dead.status&&b.char_list[f].dead.day===a&&"vote"==b.char_list[f].dead.type&&(h.psychic=f);""!==c&&(b.char_list[c].psychic={},b.char_list[c].psychic[a]=b.char_list[c].psychic[a]||{},b.char_list[c].psychic[a].value=h.psychic);void 0!==h.wolf&&""!==h.wolf&&h.wolf!==h.guard&&(b.char_list[h.wolf].dead={status:"dead",day:b.nowday,time:firebase.database.ServerValue.TIMESTAMP,type:"wolf"})}d=
c=0;for(f in b.char_list)"dead"!==b.char_list[f].dead.status&&("wolf"===b.char_list[f].job&&d++,"wolf"!==b.char_list[f].job&&c++);if(0===c||0===d||c===d)b.end="end",b.win=0===c?"wolf":"human",Award(b,d);else if("human"===b.nowtime)b.nowtime="wolf";else for(n in b.nowtime="human",++b.nowday,b.char_list)f=b.char_list[n],f.vote[b.nowday]={value:"",time:""},f.pass[b.nowday]={value:"",time:""},f.wolf[b.nowday]={value:"",time:""},f.divine[b.nowday]={value:"",time:""},f.psychic[b.nowday]={value:"",time:""},
f.guard[b.nowday]={value:"",time:""},f.human[b.nowday]={value:"",time:""}}DB.ref("/game/"+System["char"].game_sn).update(b)}}DB.ref("/game/"+System["char"].game_sn+"/char_list/"+System.member.account+"/"+System["char"].action+"/"+a).set({value:g,time:firebase.database.ServerValue.TIMESTAMP});System["char"].action="";MenuClick("game_list","close")}})}
function Award(g,a){var h="human",b={};0!=a&&(h="wolf");DB.ref("/char/").once("value",function(m){b=m.val();for(var e in g.char_list)"wolf"==g.char_list[e].job?"wolf"==h?(b[e].wolf_win+=1,b[e].item.money+=10*Object.keys(g.char_list).length):(b[e].wolf_lose+=1,b[e].item.money+=10):"wolf"==h?(b[e].human_lose+=1,b[e].item.money+=10):(b[e].human_win+=1,b[e].item.money+=10*Object.keys(g.char_list).length/2);DB.ref("/char/").update(b)})}
function BuyItem(g){DB.ref("/game/"+System["char"].game_sn).once("value",function(a){a=a.val();if(null===a)System._sessionStorage.menuclick.data_id[id]="list",sessionStorage.kfs=JSON.stringify(System._sessionStorage),System["char"].game_sn="",System["char"].game_day="",System["char"].game_time="",System["char"].game_end="",DB.ref("/char/"+System.member.account).update(System["char"]),MenuClick(id,"open");else{var h=a.item[g];if(void 0!==a.char_list[System.member.account].item[g])delete a.char_list[System.member.account].item[g];
else{for(var b in a.char_list[System.member.account].item)"money"!=b&&delete a.char_list[System.member.account].item[b];a.char_list[System.member.account].item[g]=h}DB.ref("/game/"+System["char"].game_sn).update(a);MenuClick("game_list","close")}})}
function EditAccount(){var g=document.querySelector("input#account"),a=document.querySelector("input#password");System.member.password=btoa(P(System.SerialNumber));g.value=System.member.account;a.value=System.member.password;g.disabled="disabled";a.disabled="disabled";DB.ref("/member/"+System.member.account).update(System.member)}
function OldAccount(){var g=document.querySelector("input#account"),a=document.querySelector("input#password");if(""!==g.value&&""!==a.value)DB.ref("/member/"+g.value).once("value",function(h){h=h.val();null!==h&&g.value!==System.member.account?a.value===h.password?(System.member=h,localStorage.kfs=JSON.stringify({wolf:System.member}),alert("\u7e7c\u627f\u5b8c\u6210"),location.reload()):!1===g.disabled&&!1===a.disabled&&(g.value="",a.value="",alert("\u5e8f\u865f/\u7e7c\u627f\u78bc\u932f\u8aa4")):
(g.value="",a.value="",g.disabled="",a.disabled="")})}function DelAccount(){!1!==confirm("\u78ba\u5b9a\u8981\u6e05\u9664\u5e33\u865f\u8cc7\u6599\u55ce?")&&System.member.account===prompt("\u8acb\u8f38\u5165\u5e33\u865f\u5e8f\u865f\u9032\u884c\u7a0b\u5e8f")&&!1!==confirm("\u6ce8\u610f!\u91cd\u7f6e\u7a0b\u5e8f\u7121\u6cd5\u6062\u5fa9\u8cc7\u6599,\u78ba\u5b9a\u8981\u7e7c\u7e8c\u55ce?")&&(localStorage.kfs="{}",alert("\u6e05\u9664\u5b8c\u6210"),location.reload())}
function EditChar(){if(""===System["char"].name)DB.ref("/char/").once("value",function(g){g=g.val();if(""===System["char"].name)for(var a in g)if(g[a].name===document.querySelector("#name").value||""===document.querySelector("#name").value){alert("\u89d2\u8272\u540d\u7a31\u5df2\u6709\u4eba\u4f7f\u7528\u53ca\u4e0d\u53ef\u7a7a\u767d");return}g=System["char"].name;System["char"].name=document.querySelector("#name").value;DB.ref("/char/"+System.member.account).update(System["char"]);g!==document.querySelector("#name").value?
(alert("\u547d\u540d\u5b8c\u6210"),location.reload()):MenuClick("char_info","open")})}
function RegisterMemberChar(){var g={};g.account=System.SerialNumber;g.password=btoa(P(System.SerialNumber));g.time_register=firebase.database.ServerValue.TIMESTAMP;g.time_last=firebase.database.ServerValue.TIMESTAMP;System.member=g;localStorage.kfs=JSON.stringify({wolf:System.member});DB.ref("/member/"+g.account).set(g);System.char_default.time_last=firebase.database.ServerValue.TIMESTAMP;DB.ref("/char/"+System.member.account).set(System.char_default);System["char"]=System.char_default};
</script>
